<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trump Game</title>
    <link rel="stylesheet" href="styles.css">
    <style>
         body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
}
button {
    padding: 10px 20px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

button:hover {
    background-color: #218838;
}

input {
    padding: 10px;
    width: calc(100% - 24px);
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
}

a {
    color: #007bff;
}

a:hover {
    text-decoration: underline;
}

#create-room, #join-room {
    margin-top: 20px;
}
        .container {
            text-align: center;
            margin-top: 20px;
              background: white;
    padding: 100%;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .table-container {
            display: flex;
            justify-content: center;
        }
        .player-position {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 10px;
        }
        .player-name {
            margin-top: 10px;
        }
        .cards {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        .card-button {
            margin: 5px;
            padding: 5px 10px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            cursor: pointer;
            font-size: 14px;
        }
        .center-cards {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .center-card {
            margin: 0 10px;
            padding: 10px;
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            width: 100px;
            text-align: center;
            font-size: 18px;
            pointer-events: none !important;
        }
        .trump-suit {
            font-size: 24px;
            margin-top: 10px;
        }
        .red {
            color: red;
        }
        .pairs-count {
            margin-top: 20px;
        }

        .winning-card {
            border: 2px solid yellow; /* Example: Yellow border */
            animation: highlight 0.5s infinite alternate; /* Blinking animation */
        }
        .chat-container {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 20px;
            height: 200px;
            overflow-y: scroll;
        }
        .chat-message {
            margin-bottom: 5px;
        }

        @keyframes highlight {
            from {
                border-color: yellow; /* Starting color */
            }
            to {
               border-color: red; /* Ending color */
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Trump Game</h1>

<!--    <div id="player-name-input">-->
<!--        <h2>Enter Your Name</h2>-->
<!--        <input type="text" id="playerName" placeholder="Enter Your Name">-->
<!--        <button id="submitNameBtn">Submit Name</button>-->
<!--    </div>-->

<!--    <div class="create-room">-->
<!--        <h2>Create a New Room</h2>-->
<!--        <button id="createRoomBtn">Create Room</button>-->
<!--        <p id="newRoomLink" style="display:none;">Room Link: <a href="#" id="roomLink"></a></p>-->
<!--    </div>-->

<!--    <div class="join-room">-->
<!--        <h2>Join an Existing Room</h2>-->
<!--        <input type="text" id="roomLinkInput" placeholder="Enter Room Link">-->
<!--        <button id="joinRoomBtn">Join Room</button>-->
<!--    </div>-->

<!--    <div class="table-container" style="display:none;">-->
<!--        <div class="player-position">-->
<!--            <h3 class="player-name" id="player-4-name">Player 4</h3>-->
<!--            <div id="player-4-hand" class="cards"></div>-->
<!--        </div>-->
<!--        <div class="player-position">-->
<!--            <h3 class="player-name" id="player-1-name">Player 1</h3>-->
<!--            <div id="player-1-hand" class="cards"></div>-->
<!--        </div>-->
<!--        <div class="player-position">-->
<!--            <h3 class="player-name" id="player-3-name">Player 3</h3>-->
<!--            <div id="player-3-hand" class="cards"></div>-->
<!--        </div>-->
<!--        <div class="player-position">-->
<!--            <h3 class="player-name" id="player-2-name">Player 2</h3>-->
<!--            <div id="player-2-hand" class="cards"></div>-->
<!--        </div>-->
<!--    </div>-->

    <div class="table-container">
        <div class="player-position">
            <h3 class="player-name">Player 4</h3>
            <div id="player-4-hand" class="cards"></div>
        </div>
        <div class="player-position">
            <h3 class="player-name">Player 1</h3>
            <div id="player-1-hand" class="cards"></div>
        </div>
        <div class="player-position">
            <h3 class="player-name">Player 3</h3>
            <div id="player-3-hand" class="cards"></div>
        </div>
        <div class="player-position">
            <h3 class="player-name">Player 2</h3>
            <div id="player-2-hand" class="cards"></div>
        </div>
    </div>

    <div id="trump-suit-container" style="display: none;">
        <h2>Select Trump Suit</h2>
        <button onclick="chooseTrump('Hearts')">Hearts</button>
        <button onclick="chooseTrump('Diamonds')">Diamonds</button>
        <button onclick="chooseTrump('Spades')">Spades</button>
        <button onclick="chooseTrump('Clubs')">Clubs</button>
    </div>
    <div id="trump-suit" class="trump-suit"></div>

    <div id="start-game">
        <button style="display: inline-block;" onclick="initializeGame()">Start Game</button>
    </div>

    <div id="current-player" class="player-info"></div>

    <div id="game-result" style="display: none;">
        <h2>Game Result</h2>
        <p id="game-result-message"></p>
    </div>

    <div class="center-cards">
        <div id="center-card-1" class="center-card"></div>
        <div id="center-card-2" class="center-card"></div>
        <div id="center-card-3" class="center-card"></div>
        <div id="center-card-4" class="center-card"></div>
    </div>

    <div class="pairs-count">
        <h2>Pairs:</h2>
        <p id="player-1-pairs">Player 1: 0</p>
        <p id="player-2-pairs">Player 2: 0</p>
        <p id="player-3-pairs">Player 3: 0</p>
        <p id="player-4-pairs">Player 4: 0</p>
    </div>
<!--    <div class="chat-container" id="chatContainer">-->
<!--        <h2>Chat</h2>-->
<!--        <div id="chatMessages"></div>-->
<!--        <input type="text" id="chatInput" placeholder="Type your message...">-->
<!--        <button id="sendChatBtn">Send</button>-->
    </div>
</div>

<script>
    let playerHands = [[], [], [], []];
let currentPlayerIndex = 0;
let selectedCard = null;
let game = null;
let pairsCount = [0, 0, 0, 0];
let trumpChosen = false;
 let playerNames = [];
    let playerId = null;
    let socket = null;

<!--   document.getElementById('submitNameBtn').addEventListener('click', () => {-->
<!--        const playerName = document.getElementById('playerName').value.trim();-->
<!--        if (playerName) {-->
<!--            playerId = playerNames.length;-->
<!--            playerNames.push(playerName);-->
<!--            document.getElementById(`player-${playerId + 1}-name`).innerText = playerName;-->
<!--            document.getElementById('player-name-input').style.display = 'none';-->
<!--            document.querySelector('.table-container').style.display = 'block';-->

<!--            if (playerNames.length === 4) {-->
<!--                document.getElementById('start-game').style.display = 'block';-->
<!--                highlightJoinedPlayers();-->
<!--            }-->
<!--        } else {-->
<!--            alert('Please enter a valid name.');-->
<!--        }-->
<!--    });-->

<!--&lt;!&ndash;    function highlightJoinedPlayers() {&ndash;&gt;-->
<!--&lt;!&ndash;        playerNames.forEach((name, index) => {&ndash;&gt;-->
<!--&lt;!&ndash;            const playerElement = document.getElementById(`player-${index + 1}-name`);&ndash;&gt;-->
<!--&lt;!&ndash;            playerElement.classList.add('joined');&ndash;&gt;-->
<!--&lt;!&ndash;        });&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--    document.getElementById('createRoomBtn').addEventListener('click', createRoom);-->
<!--    document.getElementById('joinRoomBtn').addEventListener('click', joinRoom);-->

<!--    function createRoom(playerName) {-->
<!--        // Simulate generating room ID and link-->
<!--        const roomId = generateRoomId();-->
<!--        const roomLink = `${window.location.href}room.html?room=${roomId}`;-->
<!--        document.getElementById('roomLink').href = roomLink;-->
<!--        document.getElementById('roomLink').textContent = roomLink;-->

<!--        // Display the game interface-->
<!--        document.getElementById('gameInterface').style.display = 'block';-->

<!--        // Initialize WebSocket connection-->
<!--        socket = new WebSocket(`wss://example.com/room/${roomId}`);-->

<!--        socket.onopen = () => {-->
<!--            console.log('WebSocket is connected.');-->
<!--            socket.send(JSON.stringify({ type: 'join', playerName: playerName, playerIndex: 0 }));-->
<!--        };-->

<!--        socket.onmessage = (event) => {-->
<!--            const message = JSON.parse(event.data);-->
<!--            handleSocketMessage(message);-->
<!--        };-->

<!--        socket.onclose = () => {-->
<!--            console.log('WebSocket is closed.');-->
<!--        };-->
<!--    }-->

<!--    function joinRoomWithName(playerName) {-->
<!--        const roomLink = document.getElementById('roomLinkInput').value.trim();-->
<!--        if (!roomLink) {-->
<!--            alert('Please enter a valid room link.');-->
<!--            return;-->
<!--        }-->

<!--        const roomId = roomLink.split('room=')[1];-->
<!--        if (!roomId) {-->
<!--            alert('Invalid room link format.');-->
<!--            return;-->
<!--        }-->

<!--        // Initialize WebSocket connection-->
<!--        socket = new WebSocket(`ws://localhost:9090/game-websocket`);-->

<!--        socket.onopen = () => {-->
<!--            console.log('WebSocket is connected.');-->
<!--            socket.send(JSON.stringify({ type: 'join', playerName: playerName, playerIndex: playerId }));-->
<!--        };-->

<!--        socket.onmessage = (event) => {-->
<!--            const message = JSON.parse(event.data);-->
<!--            handleSocketMessage(message);-->
<!--        };-->

<!--        socket.onclose = () => {-->
<!--            console.log('WebSocket is closed.');-->
<!--        };-->

<!--        // Display the game interface-->
<!--        document.getElementById('gameInterface').style.display = 'block';-->
<!--    }-->


<!--    function generateRoomId() {-->
<!--        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {-->
<!--            const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);-->
<!--            return v.toString(16);-->
<!--        });-->
<!--    }-->

<!--    function handleSocketMessage(message) {-->
<!--        switch (message.type) {-->
<!--            case 'playerJoined':-->
<!--                updatePlayerJoined(message.playerName, message.playerIndex);-->
<!--                break;-->
<!--            case 'gameStarted':-->
<!--                startGame(message.game);-->
<!--                break;-->
<!--            case 'cardPlayed':-->
<!--                updateGame(message.game);-->
<!--                break;-->
<!--            case 'roundWinner':-->
<!--                updateRoundWinner(message.winnerIndex);-->
<!--                break;-->
<!--            case 'gameOver':-->
<!--                displayGameResult(message.winnerIndex);-->
<!--                break;-->
<!--            default:-->
<!--                console.log('Unknown message type:', message.type);-->
<!--        }-->
<!--    }-->

<!--    function updatePlayerJoined(playerName, playerIndex) {-->
<!--        playerNames[playerIndex] = playerName;-->
<!--        document.getElementById(`player-${playerIndex + 1}-name`).innerText = playerName;-->
<!--        document.getElementById(`player-${playerIndex + 1}-name`).classList.add('joined');-->
<!--        displayPlayerJoinStatus();-->
<!--    }-->

<!--    function displayPlayerJoinStatus() {-->
<!--        const joinedCount = playerNames.filter(name => name).length;-->
<!--        const remainingCount = 4 - joinedCount;-->
<!--        if (remainingCount > 0) {-->
<!--            document.getElementById('current-player').innerText = `Waiting for ${remainingCount} more player(s) to join...`;-->
<!--        } else {-->
<!--            document.getElementById('start-game').style.display = 'block';-->
<!--        }-->
<!--    }-->

<!--    function displayChatMessage(playerName, text) {-->
<!--    const chatMessages = document.getElementById('chatMessages');-->
<!--    const messageElement = document.createElement('div');-->
<!--    messageElement.classList.add('chat-message');-->
<!--    messageElement.innerHTML = `<strong>${playerName}:</strong> ${text}`;-->
<!--    chatMessages.appendChild(messageElement);-->
<!--    chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom-->
<!--}-->

<!--document.getElementById('sendChatBtn').addEventListener('click', () => {-->
<!--    const messageInput = document.getElementById('chatInput');-->
<!--    const message = messageInput.value.trim();-->
<!--    if (message) {-->
<!--        socket.send(JSON.stringify({ type: 'chat', playerName: playerNames[playerId], text: message }));-->
<!--        displayChatMessage(playerNames[playerId], message);-->
<!--        messageInput.value = '';-->
<!--    }-->
<!--});-->


function initializeGame() {
console.log('initializeGame function started');
    fetch('/api/game/start', {
        method: 'GET',
    }).then(response => response.json()).then(data => {
        game = data;
        updateGame(data);
        document.getElementById('start-game').style.display = 'none';
        document.getElementById('trump-suit-container').style.display = 'block';
    }).catch(error => {
        console.error('Error fetching game data:', error);
    });
}

function updateGame(game) {
console.log('updateGame function started');
    game.players.forEach((player, index) => {
        playerHands[index] = player.hand;
    });
    currentPlayerIndex = game.currentPlayerIndex;
    displayInitialPlayerHands();
    displayCurrentPlayer();
}

function displayInitialPlayerHands() {
console.log('displayInitialPlayerHands function started');
    const playerHandsContainers = [
        document.getElementById('player-1-hand'),
        document.getElementById('player-2-hand'),
        document.getElementById('player-3-hand'),
        document.getElementById('player-4-hand')
    ];

    playerHandsContainers.forEach((container, index) => {
        container.innerHTML = '';
        playerHands[index].forEach((card, cardIndex) => {
            container.innerHTML += `<button class="card-button ${getColorForSuit(card.suit)}" onclick="selectCard(${index}, ${cardIndex})">${getCardSymbol(card.suit)} ${card.rank}</button>`;
        });
    });
}

function displayCurrentPlayer() {
console.log('displayCurrentPlayer function started');
    const currentPlayerElement = document.getElementById('current-player');
    currentPlayerElement.innerText = `Current Player: Player ${currentPlayerIndex + 1}`;
}

function chooseTrump(suit) {
console.log('chooseTrump function started');
    fetch(`/api/game/choose-trump?trumpSuit=${suit}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(game)
    }).then(response => response.json()).then(data => {
        game = data;
        trumpChosen = true;
        document.getElementById('trump-suit-container').style.display = 'none';
        document.getElementById('trump-suit').innerHTML = `<span class="trump-symbol ${getColorForSuit(suit)}">${getCardSymbol(suit)}</span>`;
        updateGame(data);
        playRound(); // Start the first round after trump suit is chosen
    }).catch(error => {
        console.error('Error choosing trump suit:', error);
    });
}

function selectCard(playerIndex, cardIndex) {
    console.log('selectCard function started');
    if (!trumpChosen || playerIndex !== currentPlayerIndex) {
        return;
    }

    const selectedCard = playerHands[playerIndex][cardIndex];
    const leadSuit = roundCards[0]?.suit || ''; // Get lead suit from the first card played in the round

    // Check if player has lead suit cards and if the selected card is not of lead suit
    if (leadSuit && selectedCard.suit !== leadSuit && hasLeadSuitCards(playerHands[playerIndex], leadSuit)) {
        alert(`Please select a card of ${leadSuit} suit.`);
        return;
    }

    console.log(`Player ${playerIndex + 1} plays: ${selectedCard.rank} of ${selectedCard.suit}`);
    selectedCard.playerIndex = playerIndex;
    roundCards.push(selectedCard); // Add selected card to round cards
    updateCenterCards(selectedCard, playerIndex);
    playerHands[playerIndex].splice(cardIndex, 1);
    displayInitialPlayerHands();
    currentPlayerIndex = (currentPlayerIndex + 1) % 4;
    displayCurrentPlayer();

    if (isRoundComplete()) {
        console.log('Round is complete. Determining round winner...');
        determineRoundWinner();
    } else {
        const newLeadSuit = roundCards[0]?.suit || '';
        enableCardsForLeadSuit(currentPlayerIndex, newLeadSuit); // Enable cards for next player based on new lead suit
    }
}

function hasLeadSuitCards(cards, leadSuit) {
    return cards.some(card => card.suit === leadSuit);
}


function updateCenterCards(card, playerIndex) {
console.log('updateCenterCards function started');
    const centerCards = document.querySelectorAll('.center-card');
    for (let i = 0; i < centerCards.length; i++) {
        if (centerCards[i].innerHTML === '') {
            centerCards[i].innerHTML = `<div class="${getColorForSuit(card.suit)}">${getCardSymbol(card.suit)} ${card.rank}</div>`;
            centerCards[i].setAttribute('data-player-index', card.playerIndex); // Set data attribute for player index
            break;
        }
    }
}

function getColorForSuit(suit) {
console.log('getColorForSuit function started');
    return suit === 'Hearts' || suit === 'Diamonds' ? 'red' : '';
}

function getCardSymbol(suit) {
console.log('getCardSymbol function started');
    switch (suit) {
        case 'Hearts':
            return '&#9829;';
        case 'Diamonds':
            return '&#9830;';
        case 'Spades':
            return '&#9824;';
        case 'Clubs':
            return '&#9827;';
        default:
            return '';
    }
}

function isRoundComplete() {
console.log('isRoundComplete function started');
    const centerCards = document.querySelectorAll('.center-card');
    return Array.from(centerCards).every(card => card.innerHTML !== '');
}

function determineRoundWinner() {
console.log('determineRoundWinner function started');
    const centerCards = document.querySelectorAll('.center-card');
    const roundCards = [];
    centerCards.forEach(cardElement => {
        const cardText = cardElement.innerHTML.trim();
        if (cardText !== '') {
<!--            const symbolMatch = cardText.match(/(\W+)\s*([\dJQKA]+)/); // Adjust regex to match card symbols and ranks-->
            const symbolMatch = cardText.match(/([♥♦♠♣])\s*([\dJQKA]+)/);
            if (symbolMatch) {
                const symbol = symbolMatch[1];
                const rank = symbolMatch[2];
                const suit = getSuitFromSymbol(symbol);
                const playerIndex = parseInt(cardElement.getAttribute('data-player-index')); // Get player index from data attribute
                roundCards.push({ suit, rank, playerIndex });
            }
        }
    });

    const leadSuit = roundCards[0]?.suit || '';
    const trumpSuit = game.trumpSuit;

    fetch('/api/game/determineRoundWinner', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            game: game, // Ensure game object is correctly defined in your JS scope
            roundCards: roundCards,
            leadSuit: leadSuit,
            trumpSuit: game.trumpSuit // Assuming game.trumpSuit is accessible
        })
    }).then(response => {
        if (!response.ok) {
            throw new Error(`Error: ${response.statusText}`);
        }
        return response.json();
    }).then(winningPlayerIndex => {
        pairsCount[winningPlayerIndex]++;
        updatePairsCount();
        highlightWinningCard(winningPlayerIndex); // Highlight the winning card
        setTimeout(clearCenterCards, 5000); // Clear center cards after 3 seconds
        currentPlayerIndex = winningPlayerIndex; // Update current player to winner for next round
        displayCurrentPlayer(); // Update current player display

        console.log(`Player ${winningPlayerIndex + 1} wins the round.`);

        if (pairsCount[0] === 7 || pairsCount[2] === 7 || pairsCount[1] === 7 || pairsCount[3] === 7) {
            endGame();
        } else {
            playRound();
        }
    }).catch(error => {
        console.error('Error determining round winner:', error);
    });
}


function highlightWinningCard(winningPlayerIndex) {
console.log('highlightWinningCard function started');
    const centerCards = document.querySelectorAll('.center-card');
    centerCards.forEach((cardElement, index) => {
        const playerIndex = parseInt(cardElement.getAttribute('data-player-index'));
        if (playerIndex === winningPlayerIndex) {
            // Apply a highlight effect to the winning card
            cardElement.classList.add('winning-card');
            setTimeout(() => {
                cardElement.classList.remove('winning-card'); // Remove the highlight effect after 2 seconds
            }, 2000);
        }
    });
}

function playRound() {
    console.log('playRound function started');
    // Check if game is finished
    if (pairsCount[0] === 7 || pairsCount[2] === 7 || pairsCount[1] === 7 || pairsCount[3] === 7) {
        endGame();
        return;
    }

    console.log(`Starting round with Player ${currentPlayerIndex + 1}`);

    // Initialize round cards
    roundCards = [];

    // Enable cards for the current player based on lead suit
    const leadSuit = roundCards[0]?.suit || '';
    enableCardsForLeadSuit(currentPlayerIndex, leadSuit);
}


function endGame() {
console.log('endGame function started');
    const gameResultMessage = document.getElementById('game-result-message');
    const winningTeam = pairsCount[0] === 7 || pairsCount[2] === 7 ? 'Team A' : 'Team B';
    gameResultMessage.textContent = `${winningTeam} wins the game!`;
    document.getElementById('game-result').style.display = 'block';
<!--    document.getElementById('start-game').style.display = 'block';-->
    clearCenterCards();

     // Countdown before reloading
    const countdownElement = document.createElement('div');
    countdownElement.id = 'countdown';
    countdownElement.style.position = 'fixed';
    countdownElement.style.top = '50%';
    countdownElement.style.left = '50%';
    countdownElement.style.transform = 'translate(-50%, -50%)';
    countdownElement.style.fontSize = '2em';
    countdownElement.style.color = 'green';
    countdownElement.style.zIndex = '1000';
    document.body.appendChild(countdownElement);

    let count = 3;
    const countdownInterval = setInterval(() => {
        countdownElement.textContent = count;
        count--;
        if (count < 0) {
            clearInterval(countdownInterval);
            location.reload();
        }
    }, 3000); // Update every second (3000 milliseconds)
}

function updatePairsCount() {
console.log('updatePairsCount function started');
    document.getElementById('player-1-pairs').innerText = `Player 1: ${pairsCount[0]}`;
    document.getElementById('player-2-pairs').innerText = `Player 2: ${pairsCount[1]}`;
    document.getElementById('player-3-pairs').innerText = `Player 3: ${pairsCount[2]}`;
    document.getElementById('player-4-pairs').innerText = `Player 4: ${pairsCount[3]}`;
}

function clearCenterCards() {
console.log('clearCenterCards function started');
    const centerCards = document.querySelectorAll('.center-card');
    centerCards.forEach(card => {
        card.innerHTML = '';
    });
}

function getSuitFromSymbol(symbol) {
console.log('getSuitFromSymbol function started');
    switch (symbol) {
        case '♥':
            return 'Hearts';
        case '♦':
            return 'Diamonds';
        case '♠':
            return 'Spades';
        case '♣':
            return 'Clubs';
        default:
            return '';
    }
}

function enableCardsForLeadSuit(playerIndex, leadSuit) {
    console.log('enableCardsForLeadSuit function started');
    const playerCards = document.querySelectorAll(`#player-${playerIndex + 1}-hand .card-button`);
    let hasLeadSuit = false;

    // Check if player has lead suit cards
    playerHands[playerIndex].forEach(card => {
        if (card.suit === leadSuit) {
            hasLeadSuit = true;
        }
    });

    playerCards.forEach((cardElement, cardIndex) => {
        const card = playerHands[playerIndex][cardIndex];
        if (hasLeadSuit && card.suit !== leadSuit) {
            cardElement.style.pointerEvents = 'none'; // Disable non-lead suit cards
        } else {
            cardElement.style.pointerEvents = 'auto'; // Enable lead suit cards or all cards if no lead suit cards
        }
    });
}
</script>
</body>
</html>

